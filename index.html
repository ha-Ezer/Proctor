<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Proctored Exam System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-x: hidden;
        }

        /* Prevent text selection and right-click */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Allow text selection in form elements */
        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        #timerBar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 3px solid rgba(255,255,255,0.2);
        }

        #timerBar.warning {
            animation: pulse 1s infinite;
            background: linear-gradient(90deg, #ff4757, #ff3742);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .exam-container {
            display: none;
            margin-top: 70px;
            padding: 20px;
            min-height: calc(100vh - 70px);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 2em;
            color: white;
            z-index: 20000;
            text-align: center;
        }

        .overlay h2 {
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        #studentForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            gap: 20px;
            padding: 40px 20px;
            border-radius: 20px;
            max-width: 500px;
            margin: 20px auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        @media (max-width: 600px) {
            #studentForm {
                margin: 10px;
                padding: 30px 15px;
                border-radius: 15px;
                max-width: none;
                min-height: calc(100vh - 20px);
            }
        }

        #studentForm h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        #studentForm input {
            padding: 15px;
            font-size: 1.1em;
            width: 100%;
            max-width: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }

        #studentForm input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #studentForm button {
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #studentForm button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        #studentForm button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .instructions {
            background: rgba(255, 235, 59, 0.1);
            border: 2px solid #ffeb3b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-width: 400px;
            text-align: left;
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .instructions ul {
            color: #555;
            padding-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            text-align: left;
        }

        .checkbox-container input[type="checkbox"] {
            width: auto;
            min-width: 20px;
        }

        .violation-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-left: 20px;
            font-size: 0.9em;
        }

        .question {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .question h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .question.required h3::after {
            content: " *";
            color: #ff4757;
        }

        .question-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .question input[type="text"], 
        .question textarea {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s ease;
            font-family: inherit;
            resize: vertical;
        }

        .question input[type="text"]:focus,
        .question textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .question textarea {
            min-height: 100px;
        }

        .multiple-choice {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .choice input[type="radio"] {
            margin: 0;
            width: auto;
        }

        .choice.selected {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .submit-section {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .submit-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Student Info Capture -->
    <div id="studentForm">
        <h2>🎓 Custom Proctored Exam System</h2>
        
        <div class="instructions">
            <h3>⚠️ Important Instructions:</h3>
            <ul>
                <li>Do not switch tabs or windows during the exam</li>
                <li>Do not minimize the browser</li>
                <li>Ensure stable internet connection</li>
                <li>Answer all required questions marked with *</li>
                <li>Your progress is automatically saved</li>
                <li>Each violation will be recorded</li>
            </ul>
        </div>

        <input type="text" id="studentName" placeholder="Full Name" required maxlength="100" />
        <input type="email" id="studentEmail" placeholder="Email Address" required />
        
        <div class="checkbox-container">
            <input type="checkbox" id="agreeTerms" required />
            <label for="agreeTerms">I agree to the exam terms and conditions</label>
        </div>
        
        <button onclick="startExam()" id="startBtn">Start Exam</button>
    </div>

    <!-- Timer + Exam -->
    <div id="timerBar">
        ⏳ Time remaining: <span id="timeLeft"></span>
        <span id="violationCount" class="violation-count">Violations: <span id="violationNumber">0</span></span>
    </div>
    
    <div id="overlay" class="overlay">
        <h2 id="overlayTitle">⏰ Time's Up!</h2>
        <div id="overlayMessage">Submitting your exam automatically...</div>
        <div class="loading"></div>
    </div>
    
    <!-- Custom Exam Form -->
    <div id="examContainer" class="exam-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <!-- Questions will be dynamically generated here -->
        <div id="questionsContainer"></div>
        
        <div class="submit-section">
            <button class="submit-btn" onclick="submitExam()" id="submitExamBtn">
                Submit Exam
            </button>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION - UPDATE THESE VALUES ==========
        const CONFIG = {
            DURATION_MINUTES: 2,
            WARNING_AT_MINUTES: 5,
            WARNING_MESSAGE: "⚠️ WARNING: Tab switching detected! This violation has been recorded.",
            MAX_VIOLATIONS: 5,
            WEBAPP_URL: "https://script.google.com/macros/s/AKfycbzcVC6Cg2jjIYbURmeV-0gqq7fmDFwA5pWd9T7H-Tjdf1r84gQw4gKiJJgDr_30TeR9Ow/exec", // Your Apps Script URL
            ENABLE_FULLSCREEN: true,
            ENABLE_SERVER_LOGGING: true,
            AUTO_SAVE_INTERVAL: 30 // seconds
        };

        // ========== EXAM QUESTIONS CONFIGURATION ==========
        const EXAM_QUESTIONS = [
            {
                id: "q1",
                type: "multiple-choice",
                question: "What is the capital of France?",
                required: true,
                options: [
                    "London",
                    "Berlin", 
                    "Paris",
                    "Madrid"
                ],
                correctAnswer: 2 // Index of correct answer (for your reference)
            },
            {
                id: "q2", 
                type: "text",
                question: "Explain the process of photosynthesis in plants.",
                required: true,
                placeholder: "Enter your detailed explanation here..."
            },
            {
                id: "q3",
                type: "multiple-choice", 
                question: "Which of the following is NOT a programming language?",
                required: false,
                options: [
                    "Python",
                    "JavaScript",
                    "HTML", 
                    "Java"
                ],
                correctAnswer: 2
            },
            {
                id: "q4",
                type: "textarea",
                question: "Describe your experience with web development technologies.",
                required: false,
                placeholder: "Share your thoughts and experiences..."
            },
            {
                id: "q5",
                type: "text",
                question: "What is 15 + 27?",
                required: true,
                placeholder: "Enter the numerical answer"
            },
            {
                id: "q6",
                type: "multiple-choice",
                question: "Which year did World War II end?",
                required: true,
                image: "https://via.placeholder.com/400x200/667eea/ffffff?text=Historical+Timeline", // Optional image
                options: [
                    "1944",
                    "1945",
                    "1946", 
                    "1947"
                ],
                correctAnswer: 1
            }
        ];
        // ========================================================

        let examState = {
            endTime: null,
            timerInterval: null,
            autoSubmitTimer: null,
            autoSaveInterval: null,
            violations: 0,
            startTime: null,
            studentData: {},
            examActive: false,
            sessionId: null,
            terminated: false,
            responses: {},
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            lastFocusTime: 0,
            preventViolations: false,
            keyboardVisible: false
        };

        function generateSessionId() {
            return 'session_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function startExam() {
            const name = document.getElementById("studentName").value.trim();
            const email = document.getElementById("studentEmail").value.trim();
            const agreed = document.getElementById("agreeTerms").checked;

            if (!name || !email || !agreed) {
                showError("Please fill all fields and agree to terms.");
                return;
            }

            if (!/\S+@\S+\.\S+/.test(email)) {
                showError("Please enter a valid email address.");
                return;
            }

            examState.studentData = { name, email };
            examState.startTime = new Date();
            examState.examActive = true;
            examState.sessionId = generateSessionId();

            // Request fullscreen
            if (CONFIG.ENABLE_FULLSCREEN) {
                requestFullscreen();
            }

            // Hide student form
            document.getElementById("studentForm").style.display = "none";

            // Show timer + exam
            document.getElementById("timerBar").style.display = "block";
            document.getElementById("examContainer").style.display = "block";

            // Generate exam questions
            generateQuestions();

            // Start countdown
            examState.endTime = Date.now() + CONFIG.DURATION_MINUTES * 60 * 1000;
            examState.timerInterval = setInterval(updateTimer, 1000);
            examState.autoSubmitTimer = setTimeout(endExam, CONFIG.DURATION_MINUTES * 60 * 1000);

            // Start auto-save
            examState.autoSaveInterval = setInterval(autoSaveProgress, CONFIG.AUTO_SAVE_INTERVAL * 1000);

            // Start monitoring
            startMonitoring();

            // Log exam start
            sendToServer('logViolation', {
                violationType: 'Exam started',
                additionalInfo: 'Custom exam system initialized'
            });

            console.log("Custom exam started for:", examState.studentData);
        }

        function generateQuestions() {
            const container = document.getElementById("questionsContainer");
            container.innerHTML = "";

            EXAM_QUESTIONS.forEach((question, index) => {
                const questionDiv = document.createElement("div");
                questionDiv.className = `question ${question.required ? 'required' : ''}`;
                questionDiv.setAttribute('data-question-id', question.id);

                let questionHTML = `<h3>${index + 1}. ${question.question}</h3>`;

                if (question.image) {
                    questionHTML += `<img src="${question.image}" alt="Question ${index + 1} image" class="question-image">`;
                }

                if (question.type === 'multiple-choice') {
                    questionHTML += '<div class="multiple-choice">';
                    question.options.forEach((option, optionIndex) => {
                        questionHTML += `
                            <div class="choice" onclick="selectChoice('${question.id}', ${optionIndex})">
                                <input type="radio" name="${question.id}" value="${optionIndex}" id="${question.id}_${optionIndex}">
                                <label for="${question.id}_${optionIndex}">${option}</label>
                            </div>
                        `;
                    });
                    questionHTML += '</div>';
                } else if (question.type === 'textarea') {
                    questionHTML += `
                        <textarea 
                            id="${question.id}" 
                            placeholder="${question.placeholder || 'Enter your answer here...'}"
                            onchange="saveResponse('${question.id}', this.value)"
                            oninput="saveResponse('${question.id}', this.value)"
                            onpaste="handlePaste(event, '${question.id}')"
                        ></textarea>
                    `;
                } else if (question.type === 'text') {
                    questionHTML += `
                        <input 
                            type="text" 
                            id="${question.id}" 
                            placeholder="${question.placeholder || 'Enter your answer here...'}"
                            onchange="saveResponse('${question.id}', this.value)"
                            oninput="saveResponse('${question.id}', this.value)"
                            onpaste="handlePaste(event, '${question.id}')"
                        />
                    `;
                }

                questionDiv.innerHTML = questionHTML;
                container.appendChild(questionDiv);
            });
        }

        function handlePaste(event, questionId) {
            // Record paste violation
            if (examState.examActive) {
                const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                recordViolation('Text pasted in question ' + questionId + ' (length: ' + pastedText.length + ' chars)');
                
                // Optional: prevent paste entirely (uncomment next line to block pasting)
                // event.preventDefault();
                
                // Optional: show warning
                setTimeout(() => {
                    alert('⚠️ WARNING: Pasting detected and logged. Please type your answers manually.');
                }, 100);
            }
        }

        function selectChoice(questionId, choiceIndex) {
            // Update visual selection
            const choices = document.querySelectorAll(`[data-question-id="${questionId}"] .choice`);
            choices.forEach((choice, index) => {
                choice.classList.toggle('selected', index === choiceIndex);
                const radio = choice.querySelector('input[type="radio"]');
                radio.checked = index === choiceIndex;
            });

            // Save response
            saveResponse(questionId, choiceIndex);
        }

        function saveResponse(questionId, value) {
            examState.responses[questionId] = value;
            updateProgress();
        }

        function updateProgress() {
            const totalQuestions = EXAM_QUESTIONS.length;
            const answeredQuestions = Object.keys(examState.responses).length;
            const progress = (answeredQuestions / totalQuestions) * 100;
            
            document.getElementById("progressFill").style.width = progress + "%";
        }

        function updateTimer() {
            let remaining = examState.endTime - Date.now();
            
            if (remaining <= 0) {
                clearInterval(examState.timerInterval);
                document.getElementById("timeLeft").textContent = "00:00";
                endExam();
                return;
            }

            let minutes = Math.floor(remaining / 60000);
            let seconds = Math.floor((remaining % 60000) / 1000);
            
            const timeDisplay = String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
            document.getElementById("timeLeft").textContent = timeDisplay;

            const timerBar = document.getElementById("timerBar");
            if (minutes < CONFIG.WARNING_AT_MINUTES) {
                timerBar.classList.add("warning");
            }
        }

        function autoSaveProgress() {
            if (!examState.examActive) return;

            sendToServer('saveProgress', {
                responses: examState.responses,
                progress: (Object.keys(examState.responses).length / EXAM_QUESTIONS.length) * 100
            });
        }

        function submitExam() {
            if (!validateRequiredQuestions()) {
                return;
            }

            if (confirm("Are you sure you want to submit your exam? This action cannot be undone.")) {
                endExam(true);
            }
        }

        function validateRequiredQuestions() {
            const requiredQuestions = EXAM_QUESTIONS.filter(q => q.required);
            const missingQuestions = [];

            requiredQuestions.forEach(question => {
                if (!examState.responses[question.id] && examState.responses[question.id] !== 0) {
                    missingQuestions.push(question.question);
                }
            });

            if (missingQuestions.length > 0) {
                showError(`Please answer the following required questions:\n• ${missingQuestions.join('\n• ')}`);
                
                // Scroll to first missing question
                const firstMissing = requiredQuestions.find(q => !examState.responses[q.id] && examState.responses[q.id] !== 0);
                if (firstMissing) {
                    const element = document.querySelector(`[data-question-id="${firstMissing.id}"]`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.style.animation = 'pulse 2s';
                    }
                }
                return false;
            }

            return true;
        }

        function endExam(manualSubmit = false) {
            if (examState.terminated) return;
            
            examState.examActive = false;
            examState.terminated = true;
            clearInterval(examState.timerInterval);
            clearTimeout(examState.autoSubmitTimer);
            clearInterval(examState.autoSaveInterval);

            document.getElementById("timerBar").style.display = "none";
            document.getElementById("overlay").style.display = "flex";

            const submissionType = manualSubmit ? 'Manual submission' : 'Time expired - auto submission';
            
            // Send exam submission with all data
            console.log('Submitting exam with responses:', examState.responses);
            console.log('Exam questions:', EXAM_QUESTIONS);
            
            sendToServer('submitExam', {
                submissionType: submissionType,
                responses: examState.responses,
                examQuestions: EXAM_QUESTIONS, // Include question structure
                completionTime: new Date().toISOString()
            });

            setTimeout(() => {
                showFinalResults();
            }, 2000);
        }

        function showFinalResults() {
            document.getElementById("overlayTitle").textContent = "✅ Exam Submitted Successfully";
            document.getElementById("overlayMessage").innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3>Exam Complete!</h3>
                    <p>Student: ${examState.studentData.name}</p>
                    <p>Email: ${examState.studentData.email}</p>
                    <p>Questions Answered: ${Object.keys(examState.responses).length}/${EXAM_QUESTIONS.length}</p>
                    <p>Total Violations: ${examState.violations}</p>
                    <p>Submission Time: ${new Date().toLocaleString()}</p>
                    <br>
                    <p style="color: #28a745; font-weight: bold;">Thank you for taking the exam!</p>
                    <p>You may now close this window.</p>
                </div>
            `;
            
            document.querySelector('.loading').style.display = 'none';
        }

        function sendToServer(action, data) {
            if (!CONFIG.ENABLE_SERVER_LOGGING || !CONFIG.WEBAPP_URL.includes('script.google.com')) {
                console.log('Server logging disabled or invalid URL');
                console.log('Would send:', action, data);
                return;
            }

            const payload = {
                action: action,
                studentData: examState.studentData,
                sessionId: examState.sessionId,
                timestamp: new Date().toISOString(),
                browserInfo: navigator.userAgent,
                ...data
            };

            console.log('Sending to server:', payload);

            fetch(CONFIG.WEBAPP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Server response received (no-cors mode)');
            })
            .catch(error => {
                console.log('Error sending data to server:', error);
                // Show user that data might not have been saved
                if (action === 'submitExam') {
                    console.warn('Exam submission may have failed - please inform administrator');
                }
            });
        }

        // Monitoring functions (simplified version from previous system)
        function startMonitoring() {
            // Mobile-friendly monitoring
            if (examState.isMobile) {
                // Basic mobile monitoring without aggressive violation detection
                document.addEventListener("visibilitychange", () => {
                    if (examState.examActive && document.hidden) {
                        setTimeout(() => {
                            if (document.hidden && examState.examActive && !examState.preventViolations) {
                                recordViolation("Tab/window switch detected on mobile");
                            }
                        }, 2000);
                    }
                });

                // Mobile keyboard detection
                window.addEventListener('resize', () => {
                    const heightDiff = window.screen.height - window.innerHeight;
                    examState.keyboardVisible = heightDiff > 200;
                    examState.preventViolations = examState.keyboardVisible;
                });
            } else {
                // Desktop monitoring
                document.addEventListener("visibilitychange", () => {
                    if (examState.examActive && document.hidden) {
                        recordViolation("Tab/window switch detected");
                    }
                });

                window.addEventListener('blur', () => {
                    if (examState.examActive) {
                        recordViolation("Window lost focus");
                    }
                });
            }

            // Disable right-click
            document.addEventListener('contextmenu', e => {
                if (examState.examActive) {
                    e.preventDefault();
                    recordViolation('Right-click attempted');
                }
            });

            // Disable common keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (!examState.examActive) return;
                
                const forbidden = ['F12', 'F11'];
                const ctrlShiftKeys = ['I', 'J', 'K', 'C'];
                const ctrlKeys = ['U', 'S', 'P', 'R'];
                
                if (forbidden.includes(e.key) || 
                    (e.ctrlKey && e.shiftKey && ctrlShiftKeys.includes(e.key)) ||
                    (e.ctrlKey && ctrlKeys.includes(e.key))) {
                    e.preventDefault();
                    recordViolation('Keyboard shortcut attempted: ' + e.key);
                }
            });
        }

        function recordViolation(type) {
            if (examState.terminated || examState.preventViolations) return;
            
            examState.violations++;
            document.getElementById("violationNumber").textContent = examState.violations;
            
            sendToServer('logViolation', {
                violationType: type,
                additionalInfo: 'Custom exam system violation'
            });
            
            console.log('Violation ' + examState.violations + ': ' + type);
            
            if (!type.toLowerCase().includes('focus') && !type.toLowerCase().includes('mouse')) {
                alert(CONFIG.WARNING_MESSAGE);
            }
            
            if (examState.violations >= CONFIG.MAX_VIOLATIONS) {
                document.getElementById("overlayTitle").textContent = "⛔ Exam Terminated";
                document.getElementById("overlayMessage").innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p>Too many violations detected (${examState.violations}).</p>
                        <p>Your exam session has been terminated.</p>
                        <p>Please contact your instructor.</p>
                    </div>
                `;
                endExam();
            }
        }

        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById("errorMessage");
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
            setTimeout(() => {
                errorDiv.style.display = "none";
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById("successMessage");
            successDiv.textContent = message;
            successDiv.style.display = "block";
            setTimeout(() => {
                successDiv.style.display = "none";
            }, 3000);
        }

        // Prevent leaving page during exam
        window.addEventListener('beforeunload', function(e) {
            if (examState.examActive) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave the exam?';
                return 'Are you sure you want to leave the exam?';
            }
        });

        // Debug function - remove in production
        function testLocalSubmission() {
            if (!window.location.hostname.includes('github.io')) {
                console.log('=== TESTING LOCAL SUBMISSION ===');
                
                // Simulate student data
                examState.studentData = { name: 'Local Test Student', email: 'local@test.com' };
                examState.sessionId = 'local_test_' + Date.now();
                examState.responses = {
                    q1: 2,
                    q2: 'This is a test response',
                    q3: 1,
                    q4: 'Longer test response for textarea'
                };
                
                console.log('Student data:', examState.studentData);
                console.log('Responses:', examState.responses);
                console.log('Questions:', EXAM_QUESTIONS);
                
                // Test the submission
                sendToServer('submitExam', {
                    submissionType: 'Local test submission',
                    responses: examState.responses,
                    examQuestions: EXAM_QUESTIONS,
                    completionTime: new Date().toISOString()
                });
                
                console.log('Test submission sent - check Apps Script logs');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Custom Proctored Exam System Loaded');
            console.log('Total Questions:', EXAM_QUESTIONS.length);
            console.log('Duration:', CONFIG.DURATION_MINUTES, 'minutes');
            console.log('WebApp URL:', CONFIG.WEBAPP_URL);
            
            // Add test function to global scope for easy access
            window.testLocalSubmission = testLocalSubmission;
            
            // For debugging - uncomment this line to auto-test on local development
            // if (!window.location.hostname.includes('github.io')) testLocalSubmission();
        });
    </script>
</body>
</html>