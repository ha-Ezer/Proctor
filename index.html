<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proctored Exam System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-x: hidden; /* Allow vertical scrolling, prevent horizontal */
        }

        /* Prevent text selection and right-click */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        #timerBar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 3px solid rgba(255,255,255,0.2);
        }

        #timerBar.warning {
            animation: pulse 1s infinite;
            background: linear-gradient(90deg, #ff4757, #ff3742);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        iframe {
            width: 100%;
            height: calc(100% - 70px);
            border: none;
            display: none;
            background: white;
        }

        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 2em;
            color: white;
            z-index: 20000;
            text-align: center;
        }

        .overlay h2 {
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        #studentForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Changed from height to min-height for mobile */
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            gap: 20px;
            padding: 40px 20px; /* Added horizontal padding for mobile */
            border-radius: 20px;
            max-width: 500px;
            margin: 20px auto; /* Added margin for mobile */
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow-y: auto; /* Allow scrolling within form */
        }

        /* Mobile responsive adjustments */
        @media (max-width: 600px) {
            #studentForm {
                margin: 10px;
                padding: 30px 15px;
                border-radius: 15px;
                max-width: none;
                min-height: calc(100vh - 20px);
            }
            
            #studentForm h2 {
                font-size: 1.5em;
            }
            
            .instructions {
                font-size: 0.9em;
            }
        }

        #studentForm h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        #studentForm input {
            padding: 15px;
            font-size: 1.1em;
            width: 100%;
            max-width: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }

        #studentForm input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #studentForm button {
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #studentForm button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        #studentForm button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .instructions {
            background: rgba(255, 235, 59, 0.1);
            border: 2px solid #ffeb3b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-width: 400px;
            text-align: left;
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .instructions ul {
            color: #555;
            padding-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        .violation-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-left: 20px;
            font-size: 0.9em;
        }

        .fullscreen-prompt {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #ff6b6b;
            z-index: 15000;
            display: none;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            text-align: left;
        }

        .checkbox-container input[type="checkbox"] {
            width: auto;
            min-width: 20px;
        }

        .checkbox-container label {
            font-size: 0.9em;
            color: #333;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Termination screen styling */
        .termination-screen {
            padding: 40px 20px;
            text-align: center;
        }

        .termination-screen h2 {
            color: #ff4757;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .termination-screen p {
            font-size: 1.2em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .termination-actions {
            margin-top: 30px;
        }

        .termination-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .termination-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }
    </style>
</head>
<body>
    <!-- Student Info Capture -->
    <div id="studentForm">
        <h2>üéì Proctored Exam System</h2>
        
        <div class="instructions">
            <h3>‚ö†Ô∏è Important Instructions:</h3>
            <ul>
                <li>Do not switch tabs or windows during the exam</li>
                <li>Do not minimize the browser</li>
                <li>Ensure stable internet connection</li>
                <li>The exam will auto-submit when time expires</li>
                <li>Each violation will be recorded</li>
            </ul>
        </div>

        <input type="text" id="studentName" placeholder="Full Name" required maxlength="100" />
        <input type="email" id="studentEmail" placeholder="Email Address" required />
        
        <div class="checkbox-container">
            <input type="checkbox" id="agreeTerms" required />
            <label for="agreeTerms">I agree to the exam terms and conditions</label>
        </div>
        
        <button onclick="startExam()" id="startBtn">Start Exam</button>
    </div>

    <!-- Timer + Exam -->
    <div id="timerBar">
        ‚è≥ Time remaining: <span id="timeLeft"></span>
        <span id="violationCount" class="violation-count">Violations: <span id="violationNumber">0</span></span>
    </div>
    
    <div id="overlay" class="overlay">
        <h2 id="overlayTitle">‚è∞ Time's Up!</h2>
        <div id="overlayMessage">Submitting your exam automatically...</div>
        <div class="loading"></div>
    </div>
    
    <div id="fullscreenPrompt" class="fullscreen-prompt">
        <strong>Please return to fullscreen mode!</strong>
    </div>
    
    <iframe id="formFrame" src="" sandbox="allow-forms allow-scripts allow-same-origin"></iframe>

    <script>
        // ========== CONFIGURATION - UPDATE THESE VALUES ==========
        const CONFIG = {
            DURATION_MINUTES: 5,
            WARNING_AT_MINUTES: 5,
            WARNING_MESSAGE: "‚ö†Ô∏è WARNING: Tab switching detected! This violation has been recorded.",
            MAX_VIOLATIONS: 5,
            FORM_URL: "https://docs.google.com/forms/d/1_od1_1W-0AypoyPmIYCTbpJmYiT-ShjQdBg8h5xsKjM/viewform",
            WEBAPP_URL: "https://script.google.com/macros/s/AKfycbxmyeTfB4q0exAA56Utuf8drOVd1_4CHNSKlFNkETdXy856bqssUhaFEIFfnQzCbYHTlA/exec",
            ENABLE_FULLSCREEN: true,
            ENABLE_SERVER_LOGGING: true
        };
        // ========================================================

        let examState = {
            endTime: null,
            timerInterval: null,
            autoSubmitTimer: null,
            violations: 0,
            startTime: null,
            studentData: {},
            examActive: false,
            sessionId: null,
            formLoaded: false,
            terminated: false,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            lastFocusTime: 0,
            formInteractionStarted: false
        };

        // Generate unique session ID
        function generateSessionId() {
            return 'session_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Send violation to server
        function sendViolationToServer(violationType) {
            if (!CONFIG.ENABLE_SERVER_LOGGING || !CONFIG.WEBAPP_URL.includes('script.google.com')) {
                return;
            }

            const data = {
                action: 'logViolation',
                studentData: examState.studentData,
                violationType: violationType,
                sessionId: examState.sessionId,
                browserInfo: navigator.userAgent,
                timestamp: new Date().toISOString()
            };

            fetch(CONFIG.WEBAPP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).catch(error => {
                console.log('Error sending violation to server:', error);
            });
        }

        // Enhanced security measures
        function initSecurity() {
            // Disable right-click
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                if (examState.examActive) {
                    recordViolation('Right-click attempted');
                }
            });
            
            // Disable common keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (!examState.examActive) return;
                
                const forbidden = [
                    'F12', 'F11', // Dev tools, fullscreen toggle
                    'F5' // Refresh
                ];
                
                const ctrlShiftKeys = ['I', 'J', 'K', 'C']; // Dev tools and copy
                const ctrlKeys = ['U', 'S', 'P', 'R', 'T', 'N', 'W']; // Various shortcuts
                const altKeys = ['Tab']; // Alt-tab
                
                if (forbidden.includes(e.key) || 
                    (e.ctrlKey && e.shiftKey && ctrlShiftKeys.includes(e.key)) ||
                    (e.ctrlKey && ctrlKeys.includes(e.key)) ||
                    (e.altKey && altKeys.includes(e.key))) {
                    
                    e.preventDefault();
                    e.stopPropagation();
                    recordViolation('Keyboard shortcut attempted: ' + (e.ctrlKey ? 'Ctrl+' : '') + (e.shiftKey ? 'Shift+' : '') + (e.altKey ? 'Alt+' : '') + e.key);
                    return false;
                }
            });

            // Disable text selection and drag
            document.addEventListener('selectstart', e => e.preventDefault());
            document.addEventListener('dragstart', e => e.preventDefault());
        }

        function startExam() {
            const name = document.getElementById("studentName").value.trim();
            const email = document.getElementById("studentEmail").value.trim();
            const agreed = document.getElementById("agreeTerms").checked;

            // Validation
            if (!name || !email || !agreed) {
                alert("Please fill all fields and agree to terms.");
                return;
            }

            if (!/\S+@\S+\.\S+/.test(email)) {
                alert("Please enter a valid email address.");
                return;
            }

            // Store student data
            examState.studentData = { name, email };
            examState.startTime = new Date();
            examState.examActive = true;
            examState.sessionId = generateSessionId();

            // Request fullscreen
            if (CONFIG.ENABLE_FULLSCREEN) {
                requestFullscreen();
            }

            // Hide student form
            document.getElementById("studentForm").style.display = "none";

            // Show timer + form
            document.getElementById("timerBar").style.display = "block";
            document.getElementById("formFrame").style.display = "block";

            // Initialize exam iframe with student data
            initializeForm();

            // Start countdown
            examState.endTime = Date.now() + CONFIG.DURATION_MINUTES * 60 * 1000;
            examState.timerInterval = setInterval(updateTimer, 1000);
            examState.autoSubmitTimer = setTimeout(endExam, CONFIG.DURATION_MINUTES * 60 * 1000);

            // Start monitoring
            startMonitoring();

            // Log exam start
            sendViolationToServer('Exam started');

            console.log("Exam started for:", examState.studentData);
        }

        function initializeForm() {
            const iframe = document.getElementById("formFrame");
            let formUrl = CONFIG.FORM_URL;
            
            iframe.src = formUrl;
            
            // Wait for form to load before starting strict monitoring
            iframe.onload = function() {
                setTimeout(() => {
                    examState.formLoaded = true;
                    
                    // Add form interaction detection for mobile
                    if (examState.isMobile) {
                        // Give extra time for mobile form interactions
                        setTimeout(() => {
                            examState.formInteractionStarted = true;
                        }, 5000); // 5 seconds on mobile
                    } else {
                        examState.formInteractionStarted = true;
                    }
                    
                    // Monitor for form submission during exam
                    monitorFormSubmission();
                    
                    console.log('Form monitoring started. Mobile:', examState.isMobile);
                }, examState.isMobile ? 3000 : 2000); // Extra time for mobile
            };
        }

        function monitorFormSubmission() {
            // Check periodically if form was submitted (indicated by URL change)
            const checkSubmissionInterval = setInterval(() => {
                if (examState.terminated) {
                    clearInterval(checkSubmissionInterval);
                    return;
                }
                
                try {
                    const iframe = document.getElementById("formFrame");
                    const currentUrl = iframe.contentWindow.location.href;
                    
                    // Google Forms redirect to a confirmation page after submission
                    if (currentUrl.includes('formResponse') || currentUrl.includes('thanks') || 
                        currentUrl.includes('submitted') || currentUrl.includes('confirmation')) {
                        
                        // Form was submitted during exam time
                        examState.examActive = false;
                        examState.terminated = true;
                        clearInterval(examState.timerInterval);
                        clearTimeout(examState.autoSubmitTimer);
                        clearInterval(checkSubmissionInterval);
                        
                        // Hide timer bar
                        document.getElementById("timerBar").style.display = "none";
                        
                        // Show success message
                        showEarlySubmissionSuccess();
                        
                        console.log('Form submitted during exam time');
                    }
                } catch (e) {
                    // CORS prevents URL access - this is normal
                }
            }, 2000); // Check every 2 seconds
        }

        function showEarlySubmissionSuccess() {
            document.getElementById("overlay").style.display = "flex";
            document.getElementById("overlayTitle").textContent = "‚úÖ Exam Submitted Successfully";
            document.getElementById("overlayMessage").innerHTML = 
                '<div class="termination-screen">' +
                '<p><strong>Great job! Your exam has been submitted.</strong></p>' +
                '<p>Submitted with ' + examState.violations + ' violation(s).</p>' +
                '<p>You completed the exam early - well done!</p>' +
                '<p>You may now close this browser window.</p>' +
                '</div>';
            
            // Hide loading spinner if visible
            const loader = document.querySelector('.loading');
            if (loader) loader.style.display = 'none';
            
            // Send completion notification
            sendViolationToServer('Exam submitted early');
        }

        function updateTimer() {
            let remaining = examState.endTime - Date.now();
            
            if (remaining <= 0) {
                clearInterval(examState.timerInterval);
                document.getElementById("timeLeft").textContent = "00:00";
                endExam();
                return;
            }

            let minutes = Math.floor(remaining / 60000);
            let seconds = Math.floor((remaining % 60000) / 1000);
            
            const timeDisplay = String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
            document.getElementById("timeLeft").textContent = timeDisplay;

            // Warning color when time is low
            const timerBar = document.getElementById("timerBar");
            if (minutes < CONFIG.WARNING_AT_MINUTES) {
                timerBar.classList.add("warning");
            }
        }

        function endExam() {
            if (examState.terminated) return; // Prevent double execution
            
            examState.examActive = false;
            examState.terminated = true;
            clearInterval(examState.timerInterval);
            clearTimeout(examState.autoSubmitTimer);
            
            // Hide timer bar when exam ends
            document.getElementById("timerBar").style.display = "none";
            
            document.getElementById("overlay").style.display = "flex";
            
            // Log exam end
            sendViolationToServer('Exam ended');
            
            console.log("Exam ended for:", examState.studentData.name, 
                       "Violations:", examState.violations);

            // Try to submit the form automatically
            setTimeout(attemptFormSubmission, 2000);
        }

        function attemptFormSubmission() {
            const iframe = document.getElementById("formFrame");
            let submitted = false;

            try {
                // Try to access iframe content (may fail due to CORS)
                const iframeDoc = iframe.contentWindow.document;
                const submitBtn = iframeDoc.querySelector('div[role="button"][aria-label*="Submit"], input[type="submit"], button[type="submit"]');
                
                if (submitBtn) {
                    submitBtn.click();
                    submitted = true;
                    showTerminationSuccess();
                }
            } catch (e) {
                console.log("Cross-origin restriction, using fallback method");
            }

            if (!submitted) {
                // Show manual submission instructions with improved button
                showManualSubmissionInstructions();
            }
        }

        function showTerminationSuccess() {
            // Hide timer bar
            document.getElementById("timerBar").style.display = "none";
            
            document.getElementById("overlayTitle").textContent = "‚úÖ Exam Submitted";
            document.getElementById("overlayMessage").innerHTML = 
                '<div class="termination-screen">' +
                '<p>Your exam has been submitted successfully!</p>' +
                '<p>Total violations: ' + examState.violations + '</p>' +
                '<p>You may now close this window.</p>' +
                '</div>';
            
            // Hide loading spinner
            document.querySelector('.loading').style.display = 'none';
        }

        function showManualSubmissionInstructions() {
            // Hide timer bar
            document.getElementById("timerBar").style.display = "none";
            
            document.getElementById("overlayTitle").textContent = "üìù Please Submit Your Exam";
            document.getElementById("overlayMessage").innerHTML = 
                '<div class="termination-screen">' +
                '<p>Time is up! Please submit your exam now.</p>' +
                '<p>Total violations: ' + examState.violations + '</p>' +
                '<div class="termination-actions">' +
                '<button class="termination-button" onclick="forceFormSubmission()">' +
                'Submit My Exam Now' +
                '</button>' +
                '</div>' +
                '</div>';
            
            // Hide loading spinner
            document.querySelector('.loading').style.display = 'none';
        }

        function forceFormSubmission() {
            // Hide the overlay to access the form
            document.getElementById("overlay").style.display = "none";
            
            // Show timer bar briefly to indicate action
            const timerBar = document.getElementById("timerBar");
            timerBar.style.display = "block";
            timerBar.innerHTML = '<strong>üöÄ Auto-submitting your exam...</strong>';
            timerBar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
            
            // Try multiple methods to submit the form
            setTimeout(() => {
                const iframe = document.getElementById("formFrame");
                
                try {
                    // Method 1: Try direct access to submit button
                    const iframeDoc = iframe.contentWindow.document;
                    const submitButtons = [
                        'div[role="button"][aria-label*="Submit"]',
                        'div[role="button"][data-value="Submit"]',
                        'input[type="submit"]',
                        'button[type="submit"]',
                        'div[role="button"]:contains("Submit")',
                        '[data-submit-type="0"]',
                        'div[jsname][role="button"]'
                    ];
                    
                    let submitted = false;
                    for (const selector of submitButtons) {
                        const btn = iframeDoc.querySelector(selector);
                        if (btn) {
                            btn.click();
                            submitted = true;
                            console.log('Form submitted using selector:', selector);
                            break;
                        }
                    }
                    
                    if (submitted) {
                        // Success - show confirmation
                        setTimeout(() => {
                            timerBar.innerHTML = '<strong>‚úÖ Exam submitted successfully!</strong>';
                            setTimeout(() => {
                                showFinalConfirmation();
                            }, 2000);
                        }, 1000);
                    } else {
                        // Method 2: Try simulating Enter key on form
                        const forms = iframeDoc.querySelectorAll('form');
                        if (forms.length > 0) {
                            const form = forms[0];
                            const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                            form.dispatchEvent(submitEvent);
                            
                            setTimeout(() => {
                                timerBar.innerHTML = '<strong>‚úÖ Exam submitted via form event!</strong>';
                                setTimeout(showFinalConfirmation, 2000);
                            }, 1000);
                        } else {
                            // Fallback - direct user to submit manually
                            showManualSubmitFallback();
                        }
                    }
                    
                } catch (corsError) {
                    console.log('CORS prevents form access, showing manual instructions');
                    showManualSubmitFallback();
                }
            }, 500);
        }

        function showManualSubmitFallback() {
            document.getElementById("timerBar").style.display = "none";
            document.getElementById("overlay").style.display = "flex";
            
            document.getElementById("overlayTitle").textContent = "‚ö†Ô∏è Manual Submission Required";
            document.getElementById("overlayMessage").innerHTML = 
                '<div class="termination-screen">' +
                '<p><strong>Please look for the Submit button on the form below and click it.</strong></p>' +
                '<p>The Submit button is usually blue and located at the bottom of the form.</p>' +
                '<p>Total violations: ' + examState.violations + '</p>' +
                '<div class="termination-actions">' +
                '<button class="termination-button" onclick="hideOverlayForManualSubmission()">' +
                'I\'ll Submit Manually' +
                '</button>' +
                '</div>' +
                '</div>';
        }

        function hideOverlayForManualSubmission() {
            document.getElementById("overlay").style.display = "none";
            // Keep timer bar hidden since exam time is up
        }

        function showFinalConfirmation() {
            document.getElementById("timerBar").style.display = "none";
            document.getElementById("overlay").style.display = "flex";
            
            document.getElementById("overlayTitle").textContent = "üéâ Exam Complete";
            document.getElementById("overlayMessage").innerHTML = 
                '<div class="termination-screen">' +
                '<p><strong>Your exam has been submitted successfully!</strong></p>' +
                '<p>Exam session completed with ' + examState.violations + ' violation(s).</p>' +
                '<p>You may now close this browser window.</p>' +
                '<p style="color: #28a745; font-weight: bold;">Thank you for taking the exam!</p>' +
                '</div>';
        }

        function startMonitoring() {
            // Visibility change detection
            let hidden = "hidden";
            if (typeof document.msHidden !== "undefined") hidden = "msHidden";
            else if (typeof document.webkitHidden !== "undefined") hidden = "webkitHidden";

            document.addEventListener("visibilitychange", () => {
                // Enhanced conditions for mobile
                if (examState.examActive && 
                    examState.formLoaded && 
                    examState.formInteractionStarted && 
                    document[hidden]) {
                    
                    // On mobile, add additional checks to prevent false positives
                    if (examState.isMobile) {
                        const timeSinceLastFocus = Date.now() - examState.lastFocusTime;
                        // Only record violation if it's been more than 1 second since last focus event
                        if (timeSinceLastFocus > 1000) {
                            recordViolation("Tab/window switch detected");
                        }
                    } else {
                        recordViolation("Tab/window switch detected");
                    }
                }
            });

            // Fullscreen monitoring - less strict on mobile
            document.addEventListener('fullscreenchange', () => {
                if (examState.examActive && 
                    examState.formLoaded && 
                    examState.formInteractionStarted && 
                    !document.fullscreenElement && 
                    CONFIG.ENABLE_FULLSCREEN) {
                    
                    // On mobile, fullscreen might exit when keyboard appears
                    if (!examState.isMobile) {
                        document.getElementById("fullscreenPrompt").style.display = "block";
                        recordViolation("Exited fullscreen mode");
                        setTimeout(() => {
                            document.getElementById("fullscreenPrompt").style.display = "none";
                        }, 3000);
                    }
                }
            });

            // Focus monitoring - much more careful on mobile
            window.addEventListener('blur', () => {
                if (examState.examActive && 
                    examState.formLoaded && 
                    examState.formInteractionStarted) {
                    
                    examState.lastFocusTime = Date.now();
                    
                    // On mobile, don't record focus violations as they happen frequently with form interactions
                    if (!examState.isMobile) {
                        // Even on desktop, be less aggressive
                        setTimeout(() => {
                            if (examState.examActive && document.hidden) {
                                recordViolation("Window lost focus");
                            }
                        }, 500);
                    }
                }
            });

            // Focus event to track when user interacts with form elements
            window.addEventListener('focus', () => {
                examState.lastFocusTime = Date.now();
            });

            // Mouse leave monitoring - disabled on mobile due to touch behavior
            if (!examState.isMobile) {
                document.addEventListener('mouseleave', () => {
                    if (examState.examActive && 
                        examState.formLoaded && 
                        examState.formInteractionStarted) {
                        // Only record if mouse actually leaves and stays out
                        setTimeout(() => {
                            if (examState.examActive && document.querySelector(':hover') === null) {
                                recordViolation("Mouse left exam area");
                            }
                        }, 1000);
                    }
                });
            }
        }

        function recordViolation(type) {
            if (examState.terminated) return; // Don't record violations after termination
            
            // Filter out false violations on mobile
            if (examState.isMobile) {
                const mobileIgnorePatterns = [
                    'Window lost focus',
                    'Mouse left exam area',
                    'focus'
                ];
                
                if (mobileIgnorePatterns.some(pattern => type.toLowerCase().includes(pattern.toLowerCase()))) {
                    console.log('Mobile: Ignoring violation -', type);
                    return;
                }
                
                // Extra check for tab switching on mobile - only if truly switching
                if (type.includes('Tab/window switch') && !document.hidden) {
                    console.log('Mobile: False tab switch detection ignored');
                    return;
                }
            }
            
            examState.violations++;
            document.getElementById("violationNumber").textContent = examState.violations;
            
            // Send to server
            sendViolationToServer(type);
            
            console.log('Violation ' + examState.violations + ': ' + type + ' at ' + new Date().toISOString());
            
            // Show warning (but not for form-related focus events or mobile-specific events)
            const silentViolations = ['focus', 'Mouse left', 'Window lost focus'];
            if (!silentViolations.some(pattern => type.toLowerCase().includes(pattern.toLowerCase()))) {
                alert(CONFIG.WARNING_MESSAGE);
            }
            
            // End exam if too many violations
            if (examState.violations >= CONFIG.MAX_VIOLATIONS) {
                document.getElementById("overlayTitle").textContent = "‚õî Exam Terminated";
                document.getElementById("overlayMessage").innerHTML = '<div class="termination-screen"><p>Too many violations detected (' + examState.violations + ').</p><p>Your exam session has been terminated.</p><p>Please contact your instructor.</p></div>';
                endExam();
            }
        }

        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        // Initialize security when page loads
        document.addEventListener('DOMContentLoaded', initSecurity);

        // Prevent leaving page
        window.addEventListener('beforeunload', function(e) {
            if (examState.examActive && !examState.terminated) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave the exam?';
                return 'Are you sure you want to leave the exam?';
            }
        });

        // Additional protection against developer tools
        setInterval(() => {
            if (examState.examActive && examState.formLoaded) {
                const start = performance.now();
                debugger;
                const end = performance.now();
                if (end - start > 100) {
                    recordViolation("Developer tools detected");
                }
            }
        }, 1000);

        // Detect console access
        let devtools = {
            open: false,
            orientation: null
        };

        const threshold = 160;

        setInterval(() => {
            if (examState.examActive && examState.formLoaded && (window.outerHeight - window.innerHeight > threshold || 
                window.outerWidth - window.innerWidth > threshold)) {
                if (!devtools.open) {
                    devtools.open = true;
                    recordViolation("Developer tools opened");
                }
            } else {
                devtools.open = false;
            }
        }, 500);
    </script>
</body>
</html>