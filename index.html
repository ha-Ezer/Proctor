<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Proctored Exam System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== GLOBAL STYLES ========== */
        :root {
            --primary: #4a6cf7;
            --primary-dark: #3b5be3;
            --secondary: #764ba2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #ff4757;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --body-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--body-bg);
            overflow-x: hidden;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Prevent text selection and right-click */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Allow text selection in form elements */
        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* ========== LAYOUT COMPONENTS ========== */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            overflow: hidden;
            transition: var(--transition);
        }

        .btn {
            display: inline-block;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #20c997);
            color: white;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ========== TIMER BAR ========== */
        #timerBar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        #timerBar.warning {
            background: linear-gradient(90deg, #ff9a3d, var(--danger));
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .violation-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 16px;
            border-radius: 20px;
            margin-left: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .violation-count i {
            font-size: 1.1em;
        }

        /* ========== STUDENT FORM ========== */
        #studentForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
        }

        #studentForm .card {
            width: 100%;
            max-width: 540px;
            padding: 40px;
            text-align: center;
        }

        .form-header {
            margin-bottom: 30px;
        }

        .form-header h2 {
            font-size: 2.2em;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .form-header p {
            color: var(--gray);
            font-size: 1.1em;
        }

        .form-group {
            width: 100%;
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 16px 18px;
            font-size: 1em;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.8);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 25px 0;
        }

        .form-check-input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .form-check-label {
            font-size: 0.95em;
            color: var(--dark);
        }

        /* ========== INSTRUCTIONS ========== */
        .instructions {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.2) 100%);
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
            text-align: left;
            width: 100%;
        }

        .instructions h3 {
            color: #d39e00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }

        .instructions ul {
            color: #856404;
            padding-left: 24px;
        }

        .instructions li {
            margin: 10px 0;
            line-height: 1.5;
        }

        /* ========== EXAM CONTAINER ========== */
        .exam-container {
            display: none;
            margin-top: 70px;
            padding: 30px 20px;
            min-height: calc(100vh - 70px);
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        /* ========== QUESTIONS ========== */
        .question {
            background: white;
            margin: 25px 0;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }

        .question:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .question.required h3::after {
            content: " *";
            color: var(--danger);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .question h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
            flex: 1;
        }

        .question-type {
            background: var(--primary);
            color: white;
            font-size: 0.7em;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 15px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .question-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .question input[type="text"], 
        .question textarea {
            width: 100%;
            padding: 16px;
            font-size: 1em;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            transition: var(--transition);
            font-family: inherit;
            resize: vertical;
            background: rgba(255, 255, 255, 0.8);
        }

        .question input[type="text"]:focus,
        .question textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }

        .question textarea {
            min-height: 120px;
        }

        .multiple-choice {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.7);
        }

        .choice:hover {
            background: #f8f9fa;
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .choice input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .choice.selected {
            background: rgba(74, 108, 247, 0.1);
            border-color: var(--primary);
        }

        .choice-label {
            flex: 1;
            font-weight: 500;
        }

        /* ========== SUBMIT SECTION ========== */
        .submit-section {
            text-align: center;
            margin: 40px 0;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .submit-section h3 {
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 1.5em;
        }

        /* ========== MESSAGES ========== */
        .message {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        /* ========== OVERLAY ========== */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 1.8em;
            color: white;
            z-index: 20000;
            text-align: center;
            padding: 30px;
        }

        .overlay-content {
            max-width: 600px;
            width: 100%;
        }

        .overlay h2 {
            margin-bottom: 25px;
            color: white;
            font-size: 2.2em;
        }

        .overlay p {
            margin-bottom: 15px;
            font-size: 0.8em;
            opacity: 0.9;
        }

        .loading {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-top: 30px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== VIOLATION ALERT ========== */
        .violation-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 71, 87, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 25000;
            text-align: center;
            padding: 30px;
        }

        .violation-content {
            max-width: 500px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .violation-alert h2 {
            color: #ffff00;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .violation-alert p {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        /* ========== RESPONSIVE STYLES ========== */
        @media (max-width: 768px) {
            :root {
                font-size: 14px;
            }
            
            #studentForm .card {
                padding: 30px 20px;
            }
            
            .form-header h2 {
                font-size: 1.8em;
            }
            
            .question {
                padding: 20px;
            }
            
            .submit-section {
                padding: 30px 20px;
            }
            
            .violation-count {
                margin-left: 10px;
                padding: 4px 12px;
            }
            
            #timerBar {
                font-size: 1em;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .question-header {
                flex-direction: column;
            }
            
            .question-type {
                align-self: flex-start;
                margin: 10px 0 0 0;
            }
            
            .violation-count {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Student Info Capture -->
    <div id="studentForm">
        <div class="card">
            <div class="form-header">
                <h2><i class="fas fa-graduation-cap"></i> Custom Proctored Exam</h2>
                <p>Please enter your details to begin the examination</p>
            </div>
            
            <div class="instructions">
                <h3><i class="fas fa-exclamation-circle"></i> Important Instructions</h3>
                <ul>
                    <li>Do not switch tabs or windows during the exam</li>
                    <li>Do not minimize the browser</li>
                    <li>Ensure stable internet connection</li>
                    <li>Answer all required questions marked with *</li>
                    <li>Your progress is automatically saved</li>
                    <li>Each violation will be recorded</li>
                </ul>
            </div>

            <div class="form-group">
                <label for="studentName">Full Name</label>
                <input type="text" id="studentName" class="form-control" placeholder="Enter your full name" required maxlength="100" />
            </div>
            
            <div class="form-group">
                <label for="studentEmail">Email Address</label>
                <input type="email" id="studentEmail" class="form-control" placeholder="Enter your email address" required />
            </div>
            
            <div class="form-check">
                <input type="checkbox" id="agreeTerms" class="form-check-input" required />
                <label for="agreeTerms" class="form-check-label">I agree to the exam terms and conditions</label>
            </div>
            
            <button onclick="startExam()" id="startBtn" class="btn btn-primary">
                <i class="fas fa-play-circle"></i> Start Exam
            </button>
        </div>
    </div>

    <!-- Timer + Exam -->
    <div id="timerBar">
        <i class="fas fa-clock"></i> Time remaining: <span id="timeLeft"></span>
        <span id="violationCount" class="violation-count">
            <i class="fas fa-exclamation-triangle"></i> Violations: <span id="violationNumber">0</span>
        </span>
    </div>
    
    <div id="overlay" class="overlay">
        <div class="overlay-content">
            <h2 id="overlayTitle"><i class="fas fa-hourglass-end"></i> Time's Up!</h2>
            <div id="overlayMessage">Submitting your exam automatically...</div>
            <div class="loading"></div>
        </div>
    </div>
    
    <!-- Custom Exam Form -->
    <div id="examContainer" class="exam-container">
        <div class="container">
            <div class="progress-container">
                <div class="progress-info">
                    <span>Exam Progress</span>
                    <span id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div id="errorMessage" class="message error-message"></div>
            <div id="successMessage" class="message success-message"></div>
            
            <!-- Questions will be dynamically generated here -->
            <div id="questionsContainer"></div>
            
            <div class="submit-section">
                <h3>Ready to submit your exam?</h3>
                <p>Please review your answers before submission</p>
                <button class="btn btn-success" onclick="submitExam()" id="submitExamBtn">
                    <i class="fas fa-paper-plane"></i> Submit Exam
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION - UPDATE THESE VALUES ==========
        const CONFIG = {
            DURATION_MINUTES: 2,
            WARNING_AT_MINUTES: 5,
            WARNING_MESSAGE: "⚠️ WARNING: Tab switching detected! This violation has been recorded.",
            MAX_VIOLATIONS: 7,
            WEBAPP_URL: "https://script.google.com/macros/s/AKfycbzcVC6Cg2jjIYbURmeV-0gqq7fmDFwA5pWd9T7H-Tjdf1r84gQw4gKiJJgDr_30TeR9Ow/exec", // Your Apps Script URL
            ENABLE_FULLSCREEN: true,
            ENABLE_SERVER_LOGGING: true,
            AUTO_SAVE_INTERVAL: 30 // seconds
        };

        // ========== EXAM QUESTIONS CONFIGURATION ==========
        const EXAM_QUESTIONS = [
            {
                id: "q1",
                type: "multiple-choice",
                question: "What is the capital of France?",
                required: true,
                options: [
                    "London",
                    "Berlin", 
                    "Paris",
                    "Madrid"
                ],
                correctAnswer: 2 // Index of correct answer (for your reference)
            },
            {
                id: "q2", 
                type: "text",
                question: "Explain the process of photosynthesis in plants.",
                required: true,
                placeholder: "Enter your detailed explanation here..."
            },
            {
                id: "q3",
                type: "multiple-choice", 
                question: "Which of the following is NOT a programming language?",
                required: false,
                options: [
                    "Python",
                    "JavaScript",
                    "HTML", 
                    "Java"
                ],
                correctAnswer: 2
            },
            {
                id: "q4",
                type: "textarea",
                question: "Describe your experience with web development technologies.",
                required: false,
                placeholder: "Share your thoughts and experiences..."
            },
            {
                id: "q5",
                type: "text",
                question: "What is 15 + 27?",
                required: true,
                placeholder: "Enter the numerical answer"
            },
            {
                id: "q6",
                type: "multiple-choice",
                question: "Which year did World War II end?",
                required: true,
                image: "https://media.istockphoto.com/id/539247835/photo/cleaning-face.jpg?s=612x612&w=0&k=20&c=z7YWRk2kaPJgk_99qdkhKKTyuMh9IRZHUx-LUE-j4LM=", // Optional image
                options: [
                    "1944",
                    "1945",
                    "1946", 
                    "1947"
                ],
                correctAnswer: 1
            }
        ];
        // ========================================================

        let examState = {
            endTime: null,
            timerInterval: null,
            autoSubmitTimer: null,
            autoSaveInterval: null,
            violations: 0,
            startTime: null,
            studentData: {},
            examActive: false,
            sessionId: null,
            terminated: false,
            responses: {},
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            lastFocusTime: 0,
            preventViolations: false,
            keyboardVisible: false,
            lastViolationTime: 0, // Prevent spam violations
            violationCooldown: 2000, // 2 seconds between similar violations
            recentViolations: new Set() // Track recent violations to prevent duplicates
        };

        function generateSessionId() {
            return 'session_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function startExam() {
            const name = document.getElementById("studentName").value.trim();
            const email = document.getElementById("studentEmail").value.trim();
            const agreed = document.getElementById("agreeTerms").checked;

            if (!name || !email || !agreed) {
                showError("Please fill all fields and agree to terms.");
                return;
            }

            if (!/\S+@\S+\.\S+/.test(email)) {
                showError("Please enter a valid email address.");
                return;
            }

            examState.studentData = { name, email };
            examState.startTime = new Date();
            examState.examActive = true;
            examState.sessionId = generateSessionId();

            // Request fullscreen
            if (CONFIG.ENABLE_FULLSCREEN) {
                requestFullscreen();
            }

            // Hide student form
            document.getElementById("studentForm").style.display = "none";

            // Show timer + exam
            document.getElementById("timerBar").style.display = "block";
            document.getElementById("examContainer").style.display = "block";

            // Generate exam questions
            generateQuestions();

            // Start countdown
            examState.endTime = Date.now() + CONFIG.DURATION_MINUTES * 60 * 1000;
            examState.timerInterval = setInterval(updateTimer, 1000);
            examState.autoSubmitTimer = setTimeout(endExam, CONFIG.DURATION_MINUTES * 60 * 1000);

            // Start auto-save
            examState.autoSaveInterval = setInterval(autoSaveProgress, CONFIG.AUTO_SAVE_INTERVAL * 1000);

            // Start monitoring
            startMonitoring();

            // Log exam start
            sendToServer('logViolation', {
                violationType: 'Exam started',
                additionalInfo: 'Custom exam system initialized'
            });

            console.log("Custom exam started for:", examState.studentData);
        }

        function generateQuestions() {
            const container = document.getElementById("questionsContainer");
            container.innerHTML = "";

            EXAM_QUESTIONS.forEach((question, index) => {
                const questionDiv = document.createElement("div");
                questionDiv.className = `question ${question.required ? 'required' : ''}`;
                questionDiv.setAttribute('data-question-id', question.id);

                let questionHTML = `
                    <div class="question-header">
                        <h3>${index + 1}. ${question.question}</h3>
                        <span class="question-type">${question.type}</span>
                    </div>
                `;

                if (question.image) {
                    questionHTML += `<img src="${question.image}" alt="Question ${index + 1} image" class="question-image">`;
                }

                if (question.type === 'multiple-choice') {
                    questionHTML += '<div class="multiple-choice">';
                    question.options.forEach((option, optionIndex) => {
                        questionHTML += `
                            <div class="choice" onclick="selectChoice('${question.id}', ${optionIndex})">
                                <input type="radio" name="${question.id}" value="${optionIndex}" id="${question.id}_${optionIndex}">
                                <label for="${question.id}_${optionIndex}" class="choice-label">${option}</label>
                            </div>
                        `;
                    });
                    questionHTML += '</div>';
                } else if (question.type === 'textarea') {
                    questionHTML += `
                        <textarea 
                            id="${question.id}" 
                            class="form-control"
                            placeholder="${question.placeholder || 'Enter your answer here...'}"
                            onchange="saveResponse('${question.id}', this.value)"
                            oninput="saveResponse('${question.id}', this.value)"
                            onpaste="handlePaste(event, '${question.id}')"
                        ></textarea>
                    `;
                } else if (question.type === 'text') {
                    questionHTML += `
                        <input 
                            type="text" 
                            id="${question.id}" 
                            class="form-control"
                            placeholder="${question.placeholder || 'Enter your answer here...'}"
                            onchange="saveResponse('${question.id}', this.value)"
                            oninput="saveResponse('${question.id}', this.value)"
                            onpaste="handlePaste(event, '${question.id}')"
                        />
                    `;
                }

                questionDiv.innerHTML = questionHTML;
                container.appendChild(questionDiv);
            });
        }

        function handlePaste(event, questionId) {
            // Record paste violation
            if (examState.examActive) {
                const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                recordViolation('Text pasted in question ' + questionId + ' (length: ' + pastedText.length + ' chars)');
                
                // Optional: prevent paste entirely (uncomment next line to block pasting)
                // event.preventDefault();
                
                // Optional: show warning
                setTimeout(() => {
                    alert('⚠️ WARNING: Pasting detected and logged. Please type your answers manually.');
                }, 100);
            }
        }

        function selectChoice(questionId, choiceIndex) {
            // Update visual selection
            const choices = document.querySelectorAll(`[data-question-id="${questionId}"] .choice`);
            choices.forEach((choice, index) => {
                choice.classList.toggle('selected', index === choiceIndex);
                const radio = choice.querySelector('input[type="radio"]');
                radio.checked = index === choiceIndex;
            });

            // Save response
            saveResponse(questionId, choiceIndex);
        }

        function saveResponse(questionId, value) {
            examState.responses[questionId] = value;
            updateProgress();
        }

        function updateProgress() {
            const totalQuestions = EXAM_QUESTIONS.length;
            const answeredQuestions = Object.keys(examState.responses).length;
            const progress = (answeredQuestions / totalQuestions) * 100;
            
            document.getElementById("progressFill").style.width = progress + "%";
            document.getElementById("progressPercentage").textContent = Math.round(progress) + "%";
        }

        function updateTimer() {
            let remaining = examState.endTime - Date.now();
            
            if (remaining <= 0) {
                clearInterval(examState.timerInterval);
                document.getElementById("timeLeft").textContent = "00:00";
                endExam();
                return;
            }

            let minutes = Math.floor(remaining / 60000);
            let seconds = Math.floor((remaining % 60000) / 1000);
            
            const timeDisplay = String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
            document.getElementById("timeLeft").textContent = timeDisplay;

            const timerBar = document.getElementById("timerBar");
            if (minutes < CONFIG.WARNING_AT_MINUTES) {
                timerBar.classList.add("warning");
            }
        }

        function autoSaveProgress() {
            if (!examState.examActive) return;

            sendToServer('saveProgress', {
                responses: examState.responses,
                progress: (Object.keys(examState.responses).length / EXAM_QUESTIONS.length) * 100
            });
        }

        function submitExam() {
            if (!validateRequiredQuestions()) {
                return;
            }

            if (confirm("Are you sure you want to submit your exam? This action cannot be undone.")) {
                endExam(true);
            }
        }

        function validateRequiredQuestions() {
            const requiredQuestions = EXAM_QUESTIONS.filter(q => q.required);
            const missingQuestions = [];

            requiredQuestions.forEach(question => {
                if (!examState.responses[question.id] && examState.responses[question.id] !== 0) {
                    missingQuestions.push(question.question);
                }
            });

            if (missingQuestions.length > 0) {
                showError(`Please answer the following required questions:\n• ${missingQuestions.join('\n• ')}`);
                
                // Scroll to first missing question
                const firstMissing = requiredQuestions.find(q => !examState.responses[q.id] && examState.responses[q.id] !== 0);
                if (firstMissing) {
                    const element = document.querySelector(`[data-question-id="${firstMissing.id}"]`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.style.animation = 'pulse 2s';
                    }
                }
                return false;
            }

            return true;
        }

        function endExam(manualSubmit = false) {
            if (examState.terminated) return;
            
            examState.examActive = false;
            examState.terminated = true;
            clearInterval(examState.timerInterval);
            clearTimeout(examState.autoSubmitTimer);
            clearInterval(examState.autoSaveInterval);

            document.getElementById("timerBar").style.display = "none";
            document.getElementById("overlay").style.display = "flex";

            const submissionType = manualSubmit ? 'Manual submission' : 'Time expired - auto submission';
            
            // Send exam submission with all data
            console.log('Submitting exam with responses:', examState.responses);
            console.log('Exam questions:', EXAM_QUESTIONS);
            
            sendToServer('submitExam', {
                submissionType: submissionType,
                responses: examState.responses,
                examQuestions: EXAM_QUESTIONS, // Include question structure
                completionTime: new Date().toISOString()
            });

            setTimeout(() => {
                showFinalResults();
            }, 2000);
        }

        function showFinalResults() {
            document.getElementById("overlayTitle").textContent = "✅ Exam Submitted Successfully";
            document.getElementById("overlayMessage").innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3>Exam Complete!</h3>
                    <p>Student: ${examState.studentData.name}</p>
                    <p>Email: ${examState.studentData.email}</p>
                    <p>Questions Answered: ${Object.keys(examState.responses).length}/${EXAM_QUESTIONS.length}</p>
                    <p>Total Violations: ${examState.violations}</p>
                    <p>Submission Time: ${new Date().toLocaleString()}</p>
                    <br>
                    <p style="color: #28a745; font-weight: bold;">Thank you for taking the exam!</p>
                    <p>You may now close this window.</p>
                </div>
            `;
            
            document.querySelector('.loading').style.display = 'none';
        }

        function sendToServer(action, data) {
            if (!CONFIG.ENABLE_SERVER_LOGGING || !CONFIG.WEBAPP_URL.includes('script.google.com')) {
                console.log('Server logging disabled or invalid URL');
                console.log('Would send:', action, data);
                return;
            }

            const payload = {
                action: action,
                studentData: examState.studentData,
                sessionId: examState.sessionId,
                timestamp: new Date().toISOString(),
                browserInfo: navigator.userAgent,
                ...data
            };

            console.log('Sending to server:', payload);

            fetch(CONFIG.WEBAPP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Server response received (no-cors mode)');
            })
            .catch(error => {
                console.log('Error sending data to server:', error);
                // Show user that data might not have been saved
                if (action === 'submitExam') {
                    console.warn('Exam submission may have failed - please inform administrator');
                }
            });
        }

        // FIXED - Simple and reliable monitoring system
        function startMonitoring() {
            console.log('Starting FIXED monitoring system...');
            
            // Simple tab switching detection
            document.addEventListener("visibilitychange", () => {
                if (examState.examActive && document.hidden) {
                    recordViolation("Tab/window switch detected");
                }
            });
            
            // Simple window focus detection (desktop only)
            if (!examState.isMobile) {
                window.addEventListener('blur', () => {
                    if (examState.examActive) {
                        recordViolation("Window lost focus");
                    }
                });
            }
            
            // Right-click prevention
            document.addEventListener('contextmenu', e => {
                if (examState.examActive) {
                    e.preventDefault();
                    recordViolation('Right-click attempted');
                    return false;
                }
            });
            
            // SIMPLIFIED keyboard detection (no loops)
            document.addEventListener('keydown', function(e) {
                if (!examState.examActive) return;
                
                let violationDetected = false;
                let violationType = '';
                
                // Only check specific dangerous combinations
                if (e.key === 'F12') {
                    violationType = 'F12 Developer Tools attempted';
                    violationDetected = true;
                } else if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                    violationType = 'Ctrl+Shift+I Developer Tools attempted';
                    violationDetected = true;
                } else if (e.ctrlKey && e.shiftKey && e.key === 'J') {
                    violationType = 'Ctrl+Shift+J Console attempted';
                    violationDetected = true;
                } else if (e.ctrlKey && e.key === 'U') {
                    violationType = 'Ctrl+U View Source attempted';
                    violationDetected = true;
                }
                
                if (violationDetected) {
                    e.preventDefault();
                    e.stopPropagation();
                    recordViolation(violationType);
                    return false;
                }
            });
            
            // REMOVED: All developer tools detection loops that were causing issues
            // REMOVED: Console override that caused infinite recursion
            // REMOVED: Complex monitoring that triggered multiple times
            
            console.log('Monitoring system initialized with basic protection');
        }
        
        function recordViolation(type) {
            if (examState.terminated) return;
            
            // ANTI-SPAM PROTECTION
            const now = Date.now();
            
            // Prevent duplicate violations within cooldown period
            const violationKey = type.substring(0, 30); // First 30 chars as key
            if (examState.recentViolations.has(violationKey)) {
                console.log('Duplicate violation blocked:', type);
                return;
            }
            
            // Check cooldown period
            if (now - examState.lastViolationTime < examState.violationCooldown) {
                console.log('Violation blocked due to cooldown:', type);
                return;
            }
            
            // Mobile-specific filtering
            if (examState.isMobile && examState.preventViolations) {
                console.log('Mobile violation filtered out:', type);
                return;
            }
            
            // RECORD THE VIOLATION
            examState.violations++;
            examState.lastViolationTime = now;
            
            // Add to recent violations set and auto-remove after cooldown
            examState.recentViolations.add(violationKey);
            setTimeout(() => {
                examState.recentViolations.delete(violationKey);
            }, examState.violationCooldown);
            
            console.log('LEGITIMATE VIOLATION #' + examState.violations + ':', type);
            
            // Update UI
            document.getElementById("violationNumber").textContent = examState.violations;
            
            // Send to server (with rate limiting)
            sendToServer('logViolation', {
                violationType: type,
                additionalInfo: 'Fixed monitoring system - legitimate violation',
                deviceInfo: examState.isMobile ? 'Mobile Device' : 'Desktop Device'
            });
            
            // Show warning (simplified)
            if (!type.toLowerCase().includes('focus')) {
                showSimpleViolationWarning(type);
            }
            
            // Check termination
            if (examState.violations >= CONFIG.MAX_VIOLATIONS) {
                console.log('Maximum violations reached, terminating exam');
                endExam();
            }
        }
        
        // EMERGENCY RESET FUNCTION
        function resetViolationSystem() {
            console.log('RESETTING VIOLATION SYSTEM...');
            
            // Reset violation count
            examState.violations = 0;
            examState.lastViolationTime = 0;
            examState.recentViolations.clear();
            
            // Update display
            document.getElementById("violationNumber").textContent = "0";
            
            // Clear any existing alerts
            const alerts = document.querySelectorAll('[style*="position: fixed"]');
            alerts.forEach(alert => {
                if (alert.innerHTML.includes('VIOLATION') || alert.innerHTML.includes('WARNING')) {
                    alert.remove();
                }
            });
            
            console.log('Violation system reset - violations cleared');
            alert('Violation count has been reset to 0. The monitoring system has been fixed.');
        }
        
        function showSimpleViolationWarning(violationType) {
            // Simple alert instead of complex overlay to avoid triggering more violations
            alert(`⚠️ VIOLATION DETECTED: ${violationType}\n\nThis has been recorded. Violation ${examState.violations} of ${CONFIG.MAX_VIOLATIONS}.\n\nPlease follow exam rules carefully.`);
        }

        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById("errorMessage");
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
            setTimeout(() => {
                errorDiv.style.display = "none";
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById("successMessage");
            successDiv.textContent = message;
            successDiv.style.display = "block";
            setTimeout(() => {
                successDiv.style.display = "none";
            }, 3000);
        }

        // Prevent leaving page during exam
        window.addEventListener('beforeunload', function(e) {
            if (examState.examActive) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave the exam?';
                return 'Are you sure you want to leave the exam?';
            }
        });

        // Debug function - remove in production
        function testLocalSubmission() {
            if (!window.location.hostname.includes('github.io')) {
                console.log('=== TESTING LOCAL SUBMISSION ===');
                
                // Simulate student data
                examState.studentData = { name: 'Local Test Student', email: 'local@test.com' };
                examState.sessionId = 'local_test_' + Date.now();
                examState.responses = {
                    q1: 2,
                    q2: 'This is a test response',
                    q3: 1,
                    q4: 'Longer test response for textarea'
                };
                
                console.log('Student data:', examState.studentData);
                console.log('Responses:', examState.responses);
                console.log('Questions:', EXAM_QUESTIONS);
                
                // Test the submission
                sendToServer('submitExam', {
                    submissionType: 'Local test submission',
                    responses: examState.responses,
                    examQuestions: EXAM_QUESTIONS,
                    completionTime: new Date().toISOString()
                });
                
                console.log('Test submission sent - check Apps Script logs');
            }
        }

        // Test violation logging function
        function testViolationLogging() {
            console.log('=== TESTING VIOLATION LOGGING ===');
            
            if (!examState.studentData || !examState.studentData.name) {
                examState.studentData = { name: 'Test Student', email: 'test@example.com' };
                examState.sessionId = 'test_session_' + Date.now();
                examState.examActive = true;
                console.log('Set up test student data');
            }
            
            console.log('Current student data:', examState.studentData);
            console.log('Session ID:', examState.sessionId);
            console.log('Exam active:', examState.examActive);
            console.log('Web app URL:', CONFIG.WEBAPP_URL);
            
            // Test sending a violation
            recordViolation('Test violation - manual trigger');
            
            console.log('Test violation sent - check both browser network tab and Apps Script logs');
        }

        // Check configuration function
        function checkConfiguration() {
            console.log('=== CONFIGURATION CHECK ===');
            console.log('WEBAPP_URL:', CONFIG.WEBAPP_URL);
            console.log('ENABLE_SERVER_LOGGING:', CONFIG.ENABLE_SERVER_LOGGING);
            console.log('Is valid Google Script URL:', CONFIG.WEBAPP_URL.includes('script.google.com'));
            console.log('Current exam state:', {
                examActive: examState.examActive,
                studentData: examState.studentData,
                sessionId: examState.sessionId,
                violations: examState.violations
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Custom Proctored Exam System Loaded');
            console.log('Total Questions:', EXAM_QUESTIONS.length);
            console.log('Duration:', CONFIG.DURATION_MINUTES, 'minutes');
            console.log('WebApp URL:', CONFIG.WEBAPP_URL);
            
            // Add test functions to global scope for easy access
            window.testLocalSubmission = testLocalSubmission;
            window.testViolationLogging = testViolationLogging;
            window.checkConfiguration = checkConfiguration;
            window.resetViolationSystem = resetViolationSystem;
            
            console.log('Debug functions available:');
            console.log('- testViolationLogging() - test violation logging');
            console.log('- testLocalSubmission() - test exam submission');
            console.log('- checkConfiguration() - check current config');
            console.log('- resetViolationSystem() - reset violation count');
        });
    </script>
</body>
</html>